/*
  ==============================================================================

    This file was auto-generated by the Introjucer!
	(and heavily hand edited afterwards)

    It contains the basic startup code for a Juce application.

  ==============================================================================
*/

#include "Main.h"
#include "KitManager.h"
#include "PatternManager.h"
#include "PatternSaveDialog.h"
#include "PatternLoadDialog.h"


AirHarpApplication::AirHarpApplication()
{
}


void AirHarpApplication::initialise (const String& /*commandLine*/)
{
    // This method is where you should put your application's initialisation code..
    
    Time t = Time::getCurrentTime();
    Time thresh(2013, 5, 1, 0, 0);
    
    if (t > thresh)
    {
        AlertWindow::showMessageBox(AlertWindow::WarningIcon, "v0.0.1 Expired", "Thank you for testing this build");
        quit();
        return;
    }
    
	PropertiesFile::Options options;
	options.applicationName = "AirBeats";
	options.filenameSuffix = ".settings";
	options.folderName = "AirBeats";
	options.osxLibrarySubFolder = "Application Support";
	options.commonToAllUsers = "false";
	options.ignoreCaseOfKeyNames = true;
	options.millisecondsBeforeSaving = 0;
	options.storageFormat = PropertiesFile::storeAsXML;
	properties.setStorageParameters(options);

    mainWindow = new MainWindow();
	#if JUCE_WINDOWS
		mainWindow->setMenuBar(&mainMenu);
	#elif JUCE_MAC
		MenuBarModel::setMacMainMenu(&mainMenu);
	#endif

	XmlElement* audioState = properties.getUserSettings()->getXmlValue(AudioSettingsDialog::getPropertiesName());
    audioDeviceManager.initialise (0, 2, audioState, true, String::empty, 0);
	if (audioState != nullptr)
		delete audioState;
    //audioDeviceManager.addAudioCallback(this);
    audioSourcePlayer.setSource (&Drums::instance());
    audioDeviceManager.addAudioCallback (&audioSourcePlayer);
    Logger::outputDebugString(audioDeviceManager.getCurrentAudioDevice()->getName());
    
    PatternManager& pmgr = PatternManager::GetInstance();
	/*PatternManager::Status pstatus =*/ pmgr.BuildPatternList();
    
    String kitUuidString = AirHarpApplication::getInstance()->getProperties().getUserSettings()->getValue("selectedKitUuid", "Default");
    if (kitUuidString == "Default")
        AirHarpApplication::getInstance()->getProperties().getUserSettings()->setValue("selectedKitUuid", KitManager::GetInstance().GetItem(0)->GetUuid().toString());
}

void AirHarpApplication::shutdown()
{
    // Add your application's shutdown code here..

	if (settingsDialog != nullptr)
		delete settingsDialog;

    audioDeviceManager.removeAudioCallback (&audioSourcePlayer);
	MotionDispatcher::destruct();

	PatternManager::Destruct();
	#if JUCE_MAC
		MenuBarModel::setMacMainMenu(nullptr);
	#endif

    mainWindow = nullptr; // (deletes our window)
    //audioDeviceManager.removeAudioCallback(this);
	KitManager::Destruct();
}

//==============================================================================
void AirHarpApplication::systemRequestedQuit()
{
    // This is called when the app is being asked to quit: you can ignore this
    // request and let the app carry on running, or call quit() to allow the app to close.
    quit();
}

void AirHarpApplication::audioDeviceAboutToStart (AudioIODevice* /*device*/)
{
        
}
void AirHarpApplication::audioDeviceStopped()
{
        
}
void AirHarpApplication::audioDeviceIOCallback (const float** /*inputChannelData*/, int /*numInputChannels*/,
                            float** /*outputChannelData*/, int /*numOutputChannels*/, int /*numSamples*/)
{
}
    
void AirHarpApplication::anotherInstanceStarted (const String& /*commandLine*/)
{
    // When another instance of the app is launched while this one is running,
    // this method is invoked, and the commandLine parameter tells you what
    // the other instance's command-line arguments were.
}

bool AirHarpApplication::perform (const InvocationInfo &info)
{
	switch(info.commandID)
	{
		default :
		{
			jassertfalse;
			break;
		}

		case MainMenu::kAudioSettingsCmd :
		{
			if (settingsDialog != nullptr)
				break;

			settingsDialog = new AudioSettingsDialog(mainWindow, audioDeviceManager, properties);

			break;
		}
		case MainMenu::kSavePatternAsCmd :
		{
			UniquePtr<PatternSaveDialog> dlg(new PatternSaveDialog(mainWindow));
			int status = dlg->runModalLoop();
			if (status == 0)
				break;
			String fileName = dlg->GetFileName();
			fileName = File::createLegalFileName(fileName);
			// For now, use the default path
			PatternManager& mgr = PatternManager::GetInstance();
			File directory = mgr.GetDefaultPath();

			Drums& drums = Drums::instance();
			SharedPtr<DrumPattern> pattern = drums.getPattern();
			jassert(pattern.get() != nullptr);
			pattern->SaveToXml(fileName, directory);
			break;
		}
		case MainMenu::kLoadPatternCmd :
		{
			PatternManager& mgr = PatternManager::GetInstance();
			mgr.BuildPatternList();	// Refresh list to find new content, etc.
			UniquePtr<PatternLoadDialog> dlg(new PatternLoadDialog(mainWindow));
			int status = dlg->runModalLoop();
			if (status == 0)
				break;
			int index = dlg->GetSelection();
			if (index < 0)
				break;
			SharedPtr<DrumPattern> pattern = mgr.GetItem(index);
			Drums& drums = Drums::instance();
			drums.setPattern(pattern);
			break;
		}
	}

	return true;
}

//==============================================================================
AirHarpApplication::MainWindow::MainWindow()  :
								DocumentWindow ("AirBeats",
                                Colours::lightgrey,
                                DocumentWindow::allButtons)
{
    setContentOwned (new MainContentComponent(), true);

    centreWithSize (getWidth(), getHeight());
    setVisible (true);
    setUsingNativeTitleBar(true);
    setResizable(true, false);
}

void AirHarpApplication::MainWindow::closeButtonPressed()
{
    // This is called when the user tries to close this window. Here, we'll just
    // ask the app to quit when this happens, but you can change this to do
    // whatever you need.
    JUCEApplication::getInstance()->systemRequestedQuit();
}

//==============================================================================
// This macro generates the main() routine that launches the app.
START_JUCE_APPLICATION (AirHarpApplication)
